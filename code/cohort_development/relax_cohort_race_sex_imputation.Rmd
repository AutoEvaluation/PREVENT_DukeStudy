
## Define library path where R looks for installed packages and load them
```{r, warning=F, message=F}
.libPaths("P://Pro00110219 - Predictive modeling using EHR/ch513/Rtools")
#install.packages ("dplyr", repo="http://archive.linux.duke.edu/cran/")
packageVersion("rlang")
library(RODBC)
library(dplyr)
library(lubridate)
library(ggplot2)
library(tidyr)
library(data.table)
library(tableone)
library(Hmisc)
library(caret)
library(survival)
```

## Data Imputation


```{r}
# load
data = fread('../../data/relax_cohort2/cleaned_data.csv')

# replace extreme values
data <- data %>% mutate(age = pmin(age, 125),
                        sbp = pmin(pmax(sbp, 90), 200),
                        tc = pmin(pmax(tc, 130), 320),
                        hdlc = pmin(pmax(hdlc, 20), 100),
                        bmi = pmin(pmax(bmi, 18.5), 40))

# Impute missing values with subgroup-specific medians (race + sex)
data[, tc := ifelse(is.na(tc), median(tc, na.rm = TRUE), tc), by = .(race, sex)]
data[, hdlc := ifelse(is.na(hdlc), median(hdlc, na.rm = TRUE), hdlc), by = .(race, sex)]
data[, bmi := ifelse(is.na(bmi), median(bmi, na.rm = TRUE), bmi), by = .(race, sex)]
data[, scre := ifelse(is.na(scre), median(scre, na.rm = TRUE), scre), by = .(race, sex)]
data[, sbp := ifelse(is.na(sbp), median(sbp, na.rm = TRUE), sbp), by = .(race, sex)]
data[, eGFR := ifelse(is.na(eGFR), median(eGFR, na.rm = TRUE), eGFR), by = .(race, sex)]
```



## Data Transformation

```{r}
# transform
data$time2ascvd_10y <- pmin(data$time2mi_10y, data$time2stroke_10y)
data$ascvd_10y <- 1*((data$stroke_10y+data$mi_10y)>0)
data$time2cvd_10y <- pmin(data$time2mi_10y, data$time2stroke_10y, data$time2hf_10y)

data$time2ascvd_5y <- pmin(data$time2mi_5y, data$time2stroke_5y)
data$ascvd_5y <- 1*((data$stroke_5y+data$mi_5y)>0)
data$time2cvd_5y <- pmin(data$time2mi_5y, data$time2stroke_5y, data$time2hf_5y)

# calculate transformed 'age' column
data$age <- (data$age - 55) / 10

# calculate 'nonhdlc' based on 'tc' and 'hdlc'
data$nonhdlc <- (data$tc - data$hdlc) * 0.02586 - 3.5

# transform 'hdlc'
data$hdlc <- (data$hdlc * 0.02586 - 1.3) / 0.3

# calculate 'sbp1' using the min value of 'sbp' and 110
data$sbp1 <- (pmin(data$sbp, 110) - 110) / 20

# calculate 'sbp2' using the max value of 'sbp' and 110
data$sbp2 <- (pmax(data$sbp, 110) - 130) / 20

# calculate 'bmi1' using the min value of 'bmi' and 30
data$bmi1 <- (pmin(data$bmi, 30) - 25) / 5

# calculate 'bmi2' using the max value of 'bmi' and 30
data$bmi2 <- (pmax(data$bmi, 30) - 30) / 5

# calculate 'egfr1' using the min value of 'egfr' and 60
data$egfr1 <- (pmin(data$eGFR, 60) - 60) / -15

# calculate 'egfr2' using the max value of 'egfr' and 60
data$egfr2 <- (pmax(data$eGFR, 60) - 90) / -15

# calculate 'sbp2treat' as the product of 'sbp2' and 'antihtn'
data$sbp2treat <- data$sbp2 * data$antihtn

# calculate 'nonhdlctreat' as the product of 'nonhdlc' and 'statin'
data$nonhdlctreat <- data$nonhdlc * data$statin

# calculate 'agenonhdlc' as the product of 'age' and 'nonhdlc'
data$agenonhdlc <- data$age * data$nonhdlc

# calculate 'agehdlc' as the product of 'age' and 'hdlc'
data$agehdlc <- data$age * data$hdlc

# calculate 'agesbp2' as the product of 'age' and 'sbp2'
data$agesbp2 <- data$age * data$sbp2

# calculate 'agediabetes' as the product of 'age' and 'diabetes'
data$agediabetes <- data$age * data$diabetes

# calculate 'agecursmk' as the product of 'age' and 'cursmk'
data$agecursmk <- data$age * data$smoker

# calculate 'agebmi2' as the product of 'age' and 'bmi2'
data$agebmi2 <- data$age * data$bmi2

# calculate 'ageegfr1' as the product of 'age' and 'egfr1'
data$ageegfr1 <- data$age * data$egfr1

# set 'cons' column to 1 for all rows: for intercept
data$cons <- 1

# insurance
data$insurance_group <- with(data,
  ifelse(is.na(insurance_type), NA,
    ifelse(insurance_type %in% c("COMMERCIAL", "MANAGED CARE", "NC BLUE CROSS", "OOS BLUE CROSS"),
           "Commercial",
    ifelse(insurance_type %in% c("MEDICARE", "MEDICARE ADVANTAGE"),
           "Medicare",
    ifelse(insurance_type %in% c("MEDICAID PENDING", "NC MEDICAID", "OOS MEDICAID"),
           "Medicaid",
    ifelse(insurance_type == "SELF-PAY",
           "No Insurance",
           "Other Insurance"))))))

# split SDOH into quartiles
data <- data %>%
  mutate(
    ADI_NATRANK_BIN = cut(
      ADI_NATRANK,
      breaks = seq(0, 100, by = 25),
      labels = 1:4,
      include.lowest = TRUE))

# save
write.csv(data, '../../data/relax_cohort2/transformed_data2.csv', row.names = FALSE)
```



## PREVENT


```{r}
# 5 year coefficients
coefficients_5y <- list(
  female_cvd = matrix(c(
    0.7939329, 0.0305239, -0.1606857, -0.2394003, 0.360078, 0.8667604,
    0.5360739, 0.6045917, 0.0433769, 0.3151672, -0.1477655, -0.0663612,
    0.1197879, -0.0819715, 0.0306769, -0.0946348, -0.27057, -0.078715,
    -0.1637806, -4.165859
  ), nrow = 20, ncol = 1),
  male_cvd = matrix(c(
    0.7688528, 0.0736174, -0.0954431, -0.4347345, 0.3362658, 0.7692857,
    0.4386871, 0.5378979, 0.0164827, 0.288879, -0.1337349, -0.0475924,
    0.150273, -0.0517874, 0.0191169, -0.1049477, -0.2251948, -0.0895067,
    -0.1543702, -3.889299
  ), nrow = 20, ncol = 1),
  female_ascvd = matrix(c(
    0.7198830247, 0.1176967025, -0.1511850059, -0.0835357979, 0.3592852056,
    0.8348584771, 0.4831078053, 0.4864619076, 0.039777901, 0.2265308946,
    -0.0592373982, -0.0395761989, 0.0844423026, -0.0567838997,
    0.0325691998, -0.1035984978, -0.241754204, -0.0791141987,
    -0.167149201, -4.691118
  ), nrow = 20, ncol = 1),
  male_ascvd = matrix(c(
    0.7099847198, 0.1658663005, -0.1144284979, -0.2837212086, 0.3239977062,
    0.7189596891, 0.3956972957, 0.369007498, 0.0203619003, 0.2036522031,
    -0.0865581036, -0.0322915986, 0.1145630032, -0.0300005004,
    0.0232746992, -0.0927024037, -0.2018525004, -0.0970527008,
    -0.1217081025, -4.371798
  ), nrow = 20, ncol = 1),
  female_hf = matrix(c(
    0.8998234868, -0.4559771121, 0.3576504886, 1.038346052, 0.5839160085,
    -0.0072293999, 0.2997705936, 0.7451637983, 0.0557086989, 0.3534441888,
    -0.0981511027, -0.0946663022, -0.3581041098, -0.1159453019,
    -0.003878, -0.1884288937, -5.23739
  ), nrow = 17, ncol = 1),
  male_hf = matrix(c(
    0.8972641826, -0.6811466217, 0.3634460866, 0.9237759709, 0.5023735762,
    -0.0485840999, 0.3726929128, 0.6926916838, 0.0251826998, 0.2980921865,
    -0.0497731008, -0.1289200932, -0.3040924072, -0.140168801,
    0.0068126, -0.179777801, -4.873372
  ), nrow = 17, ncol = 1)
)

# 10 year coefficients

coefficients_10y <- list(
  female_cvd = matrix(c(
    0.7939329, 0.0305239, -0.1606857, -0.2394003, 0.360078, 0.8667604,
    0.5360739, 0.6045917, 0.0433769, 0.3151672, -0.1477655, -0.0663612,
    0.1197879, -0.0819715, 0.0306769, -0.0946348, -0.27057, -0.078715,
    -0.1637806, -3.307728
  ), nrow = 20, ncol = 1),
  male_cvd = matrix(c(
    0.7688528, 0.0736174, -0.0954431, -0.4347345, 0.3362658, 0.7692857,
    0.4386871, 0.5378979, 0.0164827, 0.288879, -0.1337349, -0.0475924,
    0.150273, -0.0517874, 0.0191169, -0.1049477, -0.2251948, -0.0895067,
    -0.1543702, -3.031168
  ), nrow = 20, ncol = 1),
  female_ascvd = matrix(c(
    0.7198830247, 0.1176967025, -0.1511850059, -0.0835357979, 0.3592852056,
    0.8348584771, 0.4831078053, 0.4864619076, 0.039777901, 0.2265308946,
    -0.0592373982, -0.0395761989, 0.0844423026, -0.0567838997,
    0.0325691998, -0.1035984978, -0.241754204, -0.0791141987,
    -0.167149201, -3.819974899
  ), nrow = 20, ncol = 1),
  male_ascvd = matrix(c(
    0.7099847198, 0.1658663005, -0.1144284979, -0.2837212086, 0.3239977062,
    0.7189596891, 0.3956972957, 0.369007498, 0.0203619003, 0.2036522031,
    -0.0865581036, -0.0322915986, 0.1145630032, -0.0300005004,
    0.0232746992, -0.0927024037, -0.2018525004, -0.0970527008,
    -0.1217081025, -3.500654936
  ), nrow = 20, ncol = 1),
  female_hf = matrix(c(
    0.8998234868, -0.4559771121, 0.3576504886, 1.038346052, 0.5839160085,
    -0.0072293999, 0.2997705936, 0.7451637983, 0.0557086989, 0.3534441888,
    -0.0981511027, -0.0946663022, -0.3581041098, -0.1159453019,
    -0.003878, -0.1884288937, -4.310409069
  ), nrow = 17, ncol = 1),
  male_hf = matrix(c(
    0.8972641826, -0.6811466217, 0.3634460866, 0.9237759709, 0.5023735762,
    -0.0485840999, 0.3726929128, 0.6926916838, 0.0251826998, 0.2980921865,
    -0.0497731008, -0.1289200932, -0.3040924072, -0.140168801,
    0.0068126, -0.179777801, -3.946391106
  ), nrow = 17, ncol = 1)
)

# predictors for each outcome
outcomes <- list(
  cvd = list(
    var = "cvd",
    covars = c(
      "age", "nonhdlc", "hdlc", "sbp1", "sbp2", "diabetes",
      "smoker", "egfr1", "egfr2", "antihtn", "statin",
      "sbp2treat", "nonhdlctreat", "agenonhdlc", "agehdlc",
      "agesbp2", "agediabetes", "agecursmk", "ageegfr1", "cons"
    )
  ),
  ascvd = list(
    var = "ascvd",
    covars = c(
      "age", "nonhdlc", "hdlc", "sbp1", "sbp2", "diabetes",
      "smoker", "egfr1", "egfr2", "antihtn", "statin",
      "sbp2treat", "nonhdlctreat", "agenonhdlc", "agehdlc",
      "agesbp2", "agediabetes", "agecursmk", "ageegfr1", "cons"
    )
  ),
  hf = list(
    var = "hf",
    covars = c(
      "age", "sbp1", "sbp2", "diabetes", "smoker", "bmi1", "bmi2",
      "egfr1", "egfr2", "antihtn", "sbp2treat", "agesbp2",
      "agediabetes", "agecursmk", "agebmi2", "ageegfr1", "cons"
    )
  )
)
```


```{r}
append_predicted_risks <- function(raw, outcomes, coefficients, prefix = "") {
  for (outcome_name in names(outcomes)) {
    new_colname <- paste0(prefix, "_prevent_", outcome_name)
    raw[, (new_colname) := NA_real_]
  }
  
  for (outcome_name in names(outcomes)) {
    covars <- outcomes[[outcome_name]]$covars
    
    for (gender_val in c(0, 1)) {
      gender_str <- ifelse(gender_val == 1, "female", "male")
      coef_key <- paste0(gender_str, "_", outcome_name)
      coef_vec <- coefficients[[coef_key]]
      
      # subset for gender
      subset_idx <- raw$sex == gender_val
      data_subset <- raw[subset_idx]
      X <- as.matrix(data_subset[, ..covars])
      
      # compute predicted probabilities
      logit <- X %*% coef_vec
      prob <- plogis(logit)
      
      # assign
      new_colname <- paste0(prefix, "_prevent_", outcome_name)
      raw[subset_idx, (new_colname) := prob]
    }
  }
  
  return(raw)
}


# apply
data <- fread('../../data/relax_cohort2/transformed_data2.csv')
data <- append_predicted_risks(data, outcomes, coefficients_5y, prefix = '5y')
data <- append_predicted_risks(data, outcomes, coefficients_10y, prefix = '10y')
```


## Local Models

## Logic: for patients in both relax and strict cohort, copy paste their local model probabilities from strict to relax
## for other patients, use local models trained on all strict cohort for risk prediction on relax cohort

## Stage 1: Copy Paste


```{r}
strict <- fread('../../data/strict_cohort2/all_data.csv')

# init columns
new_cols <- c(
  "10y_local_cvd", "10y_local_ascvd", "10y_local_hf", "5y_local_cvd",
  "5y_local_ascvd", "5y_local_hf", "10y_race_cvd", "10y_race_ascvd",
  "10y_race_hf", "5y_race_cvd", "5y_race_ascvd", "5y_race_hf",
  "10y_sdoh_cvd", "10y_sdoh_ascvd", "10y_sdoh_hf", "5y_sdoh_cvd",
  "5y_sdoh_ascvd", "5y_sdoh_hf"
)

for (col in new_cols) {
  data[[col]] <- NA_real_
}

# Set keys for joining on PATID
setkey(data, PATID)
setkey(strict, PATID)

# copy paste
for (col in new_cols) {
  data[strict, (col) := strict[[col]], on = "PATID"]}
```



## Stage 2: Local Models Trained on All Strict Cohort

```{r}
set.seed(123)

local_formulas <- list(
  cvd = "Surv(time2cvd_10y, cvd_10y) ~ age + nonhdlc + hdlc + sbp1 + sbp2 +
                           diabetes + smoker + egfr1 + egfr2 + antihtn + statin + sbp2treat +
                           nonhdlctreat + agenonhdlc + agehdlc + agesbp2 + agediabetes +
                           agecursmk + ageegfr1",
  ascvd = "Surv(time2ascvd_10y, ascvd_10y) ~ age + nonhdlc + hdlc + sbp1 + sbp2 +
                             diabetes + smoker + egfr1 + egfr2 + antihtn + statin + sbp2treat +
                             nonhdlctreat + agenonhdlc + agehdlc + agesbp2 + agediabetes +
                             agecursmk + ageegfr1",
  hf = "Surv(time2hf_10y, hf_10y) ~ age + sbp1 + sbp2 +
                         diabetes + smoker + bmi1 + bmi2 + egfr1 + egfr2 + antihtn + sbp2treat +
                         agesbp2 + agediabetes + agecursmk + agebmi2 + ageegfr1")

race_formulas <- list(
  cvd = "Surv(time2cvd_10y, cvd_10y) ~ age + nonhdlc + hdlc + sbp1 + sbp2 +
                           diabetes + smoker + egfr1 + egfr2 + antihtn + statin + sbp2treat +
                           nonhdlctreat + agenonhdlc + agehdlc + agesbp2 + agediabetes +
                           agecursmk + ageegfr1 + race",
  ascvd = "Surv(time2ascvd_10y, ascvd_10y) ~ age + nonhdlc + hdlc + sbp1 + sbp2 +
                             diabetes + smoker + egfr1 + egfr2 + antihtn + statin + sbp2treat +
                             nonhdlctreat + agenonhdlc + agehdlc + agesbp2 + agediabetes +
                             agecursmk + ageegfr1 + race",
  hf = "Surv(time2hf_10y, hf_10y) ~ age + sbp1 + sbp2 +
                         diabetes + smoker + bmi1 + bmi2 + egfr1 + egfr2 + antihtn + sbp2treat +
                         agesbp2 + agediabetes + agecursmk + agebmi2 + ageegfr1 + race")

sdoh_formulas <- list(
  cvd = "Surv(time2cvd_10y, cvd_10y) ~ age + nonhdlc + hdlc + sbp1 + sbp2 +
                           diabetes + smoker + egfr1 + egfr2 + antihtn + statin + sbp2treat +
                           nonhdlctreat + agenonhdlc + agehdlc + agesbp2 + agediabetes +
                           agecursmk + ageegfr1 + race + ADI_NATRANK_BIN",
  ascvd = "Surv(time2ascvd_10y, ascvd_10y) ~ age + nonhdlc + hdlc + sbp1 + sbp2 +
                             diabetes + smoker + egfr1 + egfr2 + antihtn + statin + sbp2treat +
                             nonhdlctreat + agenonhdlc + agehdlc + agesbp2 + agediabetes +
                             agecursmk + ageegfr1 + race + ADI_NATRANK_BIN",
  hf = "Surv(time2hf_10y, hf_10y) ~ age + sbp1 + sbp2 +
                         diabetes + smoker + bmi1 + bmi2 + egfr1 + egfr2 + antihtn + sbp2treat +
                         agesbp2 + agediabetes + agecursmk + agebmi2 + ageegfr1 + race + ADI_NATRANK_BIN")

formula_list <- list(
  local = local_formulas,
  race = race_formulas,
  sdoh = sdoh_formulas
)

# loop through each formula set
for (form_name in names(formula_list)) {
  formulas <- formula_list[[form_name]]
  
  for (event in names(formulas)) {
    formula_str <- formulas[[event]]
    
    for (gender_val in c(0, 1)) {
      gender_str <- ifelse(gender_val == 1, "female", "male")
      df <- strict[sex == gender_val]
      
      # Fit Cox model
      model <- coxph(as.formula(formula_str), data = df)
      
      # Save model
      filename <- paste0("../model/", form_name, "_", event, "_", gender_str, ".rds")
      saveRDS(model, file = filename)
    }
  }
}
```


```{r}
model_specs <- list(
  list(file = "local_cvd", col = "5y_local_cvd", year = 5, event = "cvd"),
  list(file = "local_ascvd", col = "5y_local_ascvd", year = 5, event = "ascvd"),
  list(file = "local_hf", col = "5y_local_hf", year = 5, event = "hf"),
  list(file = "race_cvd", col = "5y_race_cvd", year = 5, event = "cvd"),
  list(file = "race_ascvd", col = "5y_race_ascvd", year = 5, event = "ascvd"),
  list(file = "race_hf", col = "5y_race_hf", year = 5, event = "hf"),
  list(file = "sdoh_cvd", col = "5y_sdoh_cvd", year = 5, event = "cvd"),
  list(file = "sdoh_ascvd", col = "5y_sdoh_ascvd", year = 5, event = "ascvd"),
  list(file = "sdoh_hf", col = "5y_sdoh_hf", year = 5, event = "hf"),
  list(file = "local_cvd", col = "10y_local_cvd", year = 10, event = "cvd"),
  list(file = "local_ascvd", col = "10y_local_ascvd", year = 10, event = "ascvd"),
  list(file = "local_hf", col = "10y_local_hf", year = 10, event = "hf"),
  list(file = "race_cvd", col = "10y_race_cvd", year = 10, event = "cvd"),
  list(file = "race_ascvd", col = "10y_race_ascvd", year = 10, event = "ascvd"),
  list(file = "race_hf", col = "10y_race_hf", year = 10, event = "hf"),
  list(file = "sdoh_cvd", col = "10y_sdoh_cvd", year = 10, event = "cvd"),
  list(file = "sdoh_ascvd", col = "10y_sdoh_ascvd", year = 10, event = "ascvd"),
  list(file = "sdoh_hf", col = "10y_sdoh_hf", year = 10, event = "hf")
)


for (spec in model_specs) {
  for (gender_val in c(0, 1)) {
    gender_str <- ifelse(gender_val == 1, "female", "male")
    
    # Subset to rows of this gender
    row_indices <- which(data$sex == gender_val)
    
    # From those, find rows where the target risk column is missing
    na_indices_in_group <- which(is.na(data[[spec$col]][row_indices]))
    
    # Get actual global row indices to update later
    target_indices <- row_indices[na_indices_in_group]
    
    # Subset of data to predict on
    test_data <- data[target_indices]
    setDT(test_data)

    # Load model
    model_path <- paste0("../model/", spec$file, "_", gender_str, ".rds")
    cox_model <- readRDS(model_path)
    
    # Predict linear predictors
    cox_lp <- predict(cox_model, newdata = test_data, type = "lp")
    
    # Baseline survival at specified time
    baseline_surv <- survfit(cox_model)
    surv_val <- summary(baseline_surv, times = spec$year, extend = TRUE)$surv
    
    # Compute risk
    risk <- 1 - surv_val ^ exp(cox_lp)
    
    # Assign predicted risk to the correct positions in the full data
    data[target_indices, (spec$col) := risk]
  }
}
```



## Save

```{r}
# save
write.csv(data, '../../data/relax_cohort2/all_data2.csv', row.names = FALSE)
```



