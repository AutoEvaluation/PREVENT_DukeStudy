

```{r, warning=F, message=F}
.libPaths("P://Pro00110219 - Predictive modeling using EHR/ch513/Rtools")
#install.packages ("survcomp", repo="http://archive.linux.duke.edu/cran/")
packageVersion("rlang")
memory.limit(size=100000000)
library(RODBC)
library(dplyr)
library(lubridate)
library(ggplot2)
library(tidyr)
library(data.table)
library(tableone)
library(fmsb)
```

Use Experiments 3 Results

## Calibration Ratio across Models on Relax

```{r}
# ---------------------------
# Define file names dynamically
# ---------------------------
years <- c(5, 10)
events <- c("cvd", "ascvd", "hf")
event_labels <- c("CVD", "ASCVD", "HF")

# Function to clean column names
clean_colnames <- function(names) {
  # First replace dots with spaces
  names <- gsub("\\.", " ", names)
  # Then apply specific replacements
  names <- gsub("^Duke Local$", "Local Cox", names)
  names <- gsub("^DNN$", "Local DNN", names)
  return(names)
}

# Function to clean model names (same logic as column names)
clean_model_names <- function(names) {
  names <- gsub("^Duke Local$", "Local Cox", names)
  names <- gsub("^DNN$", "Local DNN", names)
  return(names)
}

# Generate file paths and titles
files <- c()
titles <- c()
outputs <- c()

for (y in years) {
  for (i in seq_along(events)) {
    file <- sprintf("../calibration/exp3/calibration_ratio_%sy_%s_across_models.csv", y, events[i])
    files <- c(files, file)
    outputs <- c(outputs, sprintf("plots/calibration_ratio_%sy_%s_across_models.png", y, events[i]))
    titles <- c(titles, sprintf("%s Year %s", ifelse(y == 10, 8, y), toupper(event_labels[i])))
  }
}

# ---------------------------
# Plot each radar chart and save as high-res PNG
# ---------------------------
par(mfrow = c(1, 1), mar = c(5, 2, 2, 2))

for (i in seq_along(files)) {
  df <- read.csv(files[i])
  df <- df[-(nrow(df) - 1), ]
  
  # Clean model names in the Model column
  df$Model <- clean_model_names(df$Model)
  
  rownames(df) <- df$Model
  df <- df[, -1]
  
  # Clean column names
  colnames(df) <- clean_colnames(colnames(df))

  all_axes <- colnames(df)
  local_min <- floor(min(df, na.rm = TRUE) * 1000) / 1000
  local_max <- ceiling(max(df, na.rm = TRUE) * 1000) / 1000
  reference_row <- rep(1, length(all_axes))

  radar_data <- rbind(
    rep(local_max, length(all_axes)),
    rep(local_min, length(all_axes)),
    df,
    reference_row
  )
  rownames(radar_data) <- c("max", "min", rownames(df), "Reference Line (1.0)")
  colnames(radar_data) <- gsub("\\.", " ", colnames(radar_data))

  seg_count <- 6
  step <- (local_max - local_min) / seg_count
  ring_labels <- round(seq(local_min, local_max, by = step), 3)

  palette_colors <- c("#66C2A5",  "#A6D854", "#FFD92F", "#FC8D62", "#E78AC3")
  plot_colors <- c(palette_colors[1:nrow(df)], "red")
  plot_ltys <- c(rep(2, nrow(df)), 1)
  plot_lwds <- c(rep(2, nrow(df)), 1.5)

  # Save to file
  png(outputs[i], width = 6000, height = 5000, res = 600)

  radarchart(
    radar_data,
    axistype = 1,
    seg = seg_count,
    caxislabels = ring_labels,
    pcol = plot_colors,
    plty = plot_ltys,
    plwd = plot_lwds,
    pfcol = NA,
    cglcol = "grey",
    cglty = 1,
    cglwd = 0.8,
    axislabcol = "grey",
    vlcex = 0.6
  )

  title(main = titles[i])
  par(xpd = TRUE)

  legend(
    "bottom",
    inset = c(0, -0.1),
    legend = c(rownames(df), "Reference Line (1.0)"),
    col = plot_colors,
    lty = plot_ltys,
    lwd = plot_lwds,
    bty = "n",
    horiz = TRUE,
    cex = 0.4
  )

  par(xpd = FALSE)
  dev.off()

  # Also print the same plot to screen
  radarchart(
    radar_data,
    axistype = 1,
    seg = seg_count,
    caxislabels = ring_labels,
    pcol = plot_colors,
    plty = plot_ltys,
    plwd = plot_lwds,
    pfcol = NA,
    cglcol = "grey",
    cglty = 1,
    cglwd = 0.8,
    axislabcol = "grey",
    vlcex = 0.5
  )
  title(main = titles[i])
  par(xpd = TRUE)
  legend(
    "bottom",
    inset = c(0, -0.1),
    legend = c(rownames(df), "Reference Line (1.0)"),
    col = plot_colors,
    lty = plot_ltys,
    lwd = plot_lwds,
    bty = "n",
    horiz = TRUE,
    cex = 0.25
  )
  par(xpd = FALSE)
}
```

## Calibration Ratio across Models on Strict

```{r}
# ---------------------------
# Define file names dynamically
# ---------------------------
years <- c(5, 10)
events <- c("cvd", "ascvd", "hf")
event_labels <- c("CVD", "ASCVD", "HF")

# Generate file paths and titles
files <- c()
titles <- c()
outputs <- c()

for (y in years) {
  for (i in seq_along(events)) {
    file <- sprintf("../calibration/exp3/calibration_ratio_strict_%sy_%s_across_models.csv", y, events[i])
    files <- c(files, file)
    outputs <- c(outputs, sprintf("plots/calibration_ratio_strict_%sy_%s_across_models.png", y, events[i]))
    titles <- c(titles, sprintf("%s Year %s", ifelse(y == 10, 8, y), toupper(event_labels[i])))
  }
}

# ---------------------------
# Plot each radar chart and save as high-res PNG
# ---------------------------
par(mfrow = c(1, 1), mar = c(5, 2, 2, 2))

for (i in seq_along(files)) {
  df <- read.csv(files[i])
  df <- df[-(nrow(df) - 1), ]
  
  # Clean model names in the Model column
  df$Model <- clean_model_names(df$Model)
  
  rownames(df) <- df$Model
  df <- df[, -1]
  
  # Clean column names
  colnames(df) <- clean_colnames(colnames(df))

  all_axes <- colnames(df)
  local_min <- floor(min(df, na.rm = TRUE) * 1000) / 1000
  local_max <- ceiling(max(df, na.rm = TRUE) * 1000) / 1000
  reference_row <- rep(1, length(all_axes))

  radar_data <- rbind(
    rep(local_max, length(all_axes)),
    rep(local_min, length(all_axes)),
    df,
    reference_row
  )
  rownames(radar_data) <- c("max", "min", rownames(df), "Reference Line (1.0)")
  colnames(radar_data) <- gsub("\\.", " ", colnames(radar_data))

  seg_count <- 6
  step <- (local_max - local_min) / seg_count
  ring_labels <- round(seq(local_min, local_max, by = step), 3)

  palette_colors <- c("#66C2A5",  "#A6D854", "#FFD92F", "#FC8D62", "#E78AC3")
  plot_colors <- c(palette_colors[1:nrow(df)], "red")
  plot_ltys <- c(rep(2, nrow(df)), 1)
  plot_lwds <- c(rep(2, nrow(df)), 1.5)

  # Save to file
  png(outputs[i], width = 6000, height = 5000, res = 600)

  radarchart(
    radar_data,
    axistype = 1,
    seg = seg_count,
    caxislabels = ring_labels,
    pcol = plot_colors,
    plty = plot_ltys,
    plwd = plot_lwds,
    pfcol = NA,
    cglcol = "grey",
    cglty = 1,
    cglwd = 0.8,
    axislabcol = "grey",
    vlcex = 0.6
  )

  title(main = titles[i])
  par(xpd = TRUE)

  legend(
    "bottom",
    inset = c(0, -0.1),
    legend = c(rownames(df), "Reference Line (1.0)"),
    col = plot_colors,
    lty = plot_ltys,
    lwd = plot_lwds,
    bty = "n",
    horiz = TRUE,
    cex = 0.4
  )

  par(xpd = FALSE)
  dev.off()

  # Also print the same plot to screen
  radarchart(
    radar_data,
    axistype = 1,
    seg = seg_count,
    caxislabels = ring_labels,
    pcol = plot_colors,
    plty = plot_ltys,
    plwd = plot_lwds,
    pfcol = NA,
    cglcol = "grey",
    cglty = 1,
    cglwd = 0.8,
    axislabcol = "grey",
    vlcex = 0.5
  )
  title(main = titles[i])
  par(xpd = TRUE)
  legend(
    "bottom",
    inset = c(0, -0.1),
    legend = c(rownames(df), "Reference Line (1.0)"),
    col = plot_colors,
    lty = plot_ltys,
    lwd = plot_lwds,
    bty = "n",
    horiz = TRUE,
    cex = 0.25
  )
  par(xpd = FALSE)
}
```



